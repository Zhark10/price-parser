<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —á–∏—Å–µ–ª —Å —Ñ–æ—Ç–æ</title>
    <link rel="manifest" href="manifest.json">
    <script src='https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js'></script>
    <style>
        :root {
            --primary-color: #6366F1;
            --primary-hover: #4F46E5;
            --background: #F9FAFB;
            --card-bg: #FFFFFF;
            --text-primary: #1F2937;
            --text-secondary: #6B7280;
            --border-color: #E5E7EB;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 24px;
            min-height: 100vh;
            background-color: var(--background);
            color: var(--text-primary);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .header {
            text-align: center;
            margin-bottom: 32px;
        }

        .header h1 {
            font-size: 2.5rem;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        #numbers, #result {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            display: none;
            transition: all 0.3s ease;
        }

        #numbers {
            font-size: 1.25rem;
            line-height: 1.5;
            color: var(--text-primary);
        }

        #numbers:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            outline: none;
        }

        #canvas {
            width: 100%;
            border-radius: var(--radius);
            display: none;
            box-shadow: var(--shadow);
            background: var(--card-bg);
            border: 1px solid var(--border-color);
        }

        #result {
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            color: white;
            padding: 24px;
        }

        #fileInput {
            display: none;
        }

        .loading {
            display: none;
            text-align: center;
            color: var(--text-secondary);
            font-size: 1.1rem;
            padding: 16px;
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            animation: pulse 2s infinite;
        }

        .upload-area {
            border: 2px dashed var(--primary-color);
            border-radius: var(--radius);
            padding: 40px;
            text-align: center;
            background: var(--card-bg);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .upload-area:hover {
            background: rgba(99, 102, 241, 0.05);
            transform: translateY(-2px);
        }

        .upload-area p {
            color: var(--primary-color);
            font-size: 1.25rem;
            font-weight: 500;
            margin-top: 16px;
        }

        .upload-icon {
            font-size: 48px;
            color: var(--primary-color);
            margin-bottom: 16px;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @media (max-width: 768px) {
            body {
                padding: 16px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .upload-area {
                padding: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sticky-header">
            <button class="operation-button active" data-operation="+" onclick="setOperation('+')">+</button>
            <button class="operation-button" data-operation="-" onclick="setOperation('-')">‚àí</button>
            <button class="operation-button" data-operation="*" onclick="setOperation('√ó')">√ó</button>
            <button class="operation-button" data-operation="/" onclick="setOperation('√∑')">√∑</button>
        </div>
        <input type="file" id="fileInput" accept="image/*">
        <div id="loading" class="loading">
            –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...
        </div>
        <canvas id="canvas"></canvas>
        <div id="numbers" contenteditable="true"></div>
        <div id="result">–°—É–º–º–∞: 0</div>
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üì∏</div>
            <p>–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –≥–∞–ª–µ—Ä–µ–∏</p>
        </div>
    </div>
    
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('ServiceWorker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω'))
                    .catch(err => console.log('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ServiceWorker:', err));
            });
        }

        let worker;
        // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —á–∏—Å–µ–ª –∏ –∏—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ü–≤–µ—Ç–µ
        let foundNumbersWithColors = [];
        
        async function initTesseract() {
            worker = await Tesseract.createWorker({
                logger: m => {
                    const loading = document.getElementById('loading');
                    loading.style.display = 'none';
                    loading.textContent = m.status;
                }
            });
            await worker.loadLanguage('eng');
            await worker.initialize('eng');
        }

        async function processImage(file) {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const resultDiv = document.getElementById('result');
            const numbersDiv = document.getElementById('numbers');
            const loading = document.getElementById('loading');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫–∏ —Å —á–∏—Å–ª–∞–º–∏ –∏ —Å—É–º–º–æ–π
            resultDiv.style.display = 'block';
            
            const img = new Image();
            img.src = URL.createObjectURL(file);
            
            await new Promise(resolve => {
                img.onload = resolve;
            });
            
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            ctx.drawImage(img, 0, 0);
            canvas.style.display = 'block';
            loading.style.display = 'block';
            
            try {
                const { data } = await worker.recognize(canvas);
                
                // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —á–∏—Å–ª–∞
                foundNumbersWithColors = [];
                const sum = extractAndSumNumbers(data.text, data.words, foundNumbersWithColors);
                
                // –û–±–≤–æ–¥–∏–º —á–∏—Å–ª–∞ –ø–æ—Å–ª–µ –∏—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º —Å—Ç–∏–ª–µ–º
                drawNumbersWithColor(ctx);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫–∞–Ω–≤–∞—Å
                canvas.addEventListener('click', handleCanvasClick);
            } catch (error) {
                resultDiv.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è';
                console.error('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:', error);
            } finally {
                loading.style.display = 'none';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –≤—Å–µ—Ö —á–∏—Å–µ–ª —Å –∏—Ö —Ç–µ–∫—É—â–∏–º —Ü–≤–µ—Ç–æ–º
        function drawNumbersWithColor(ctx) {
            // –û—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ç—É—Ä—ã, –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            const canvas = ctx.canvas;
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            foundNumbersWithColors.forEach((item) => {
                const { bbox, color } = item;
                const { x0, y0, x1, y1 } = bbox;
                const padding = 4;
                
                ctx.strokeStyle = color;
                ctx.lineWidth = 8;
                ctx.beginPath();
                ctx.roundRect(
                    x0 - padding, 
                    y0 - padding, 
                    x1 - x0 + padding * 2, 
                    y1 - y0 + padding * 2, 
                    8
                );
                ctx.stroke();
            });
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫–∞–Ω–≤–∞—Å
        function handleCanvasClick(e) {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–∞–Ω–≤–∞—Å–∞
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–ø–∞–ª –ª–∏ –∫–ª–∏–∫ –Ω–∞ –∫–∞–∫–æ–µ-–ª–∏–±–æ —á–∏—Å–ª–æ
            for (let i = 0; i < foundNumbersWithColors.length; i++) {
                const item = foundNumbersWithColors[i];
                const { bbox } = item;
                const { x0, y0, x1, y1 } = bbox;
                const padding = 4;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Ö–æ–¥—è—Ç –ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞ –≤ –æ–±–ª–∞—Å—Ç—å —á–∏—Å–ª–∞
                if (
                    x >= (x0 - padding) && 
                    x <= (x1 + padding) && 
                    y >= (y0 - padding) && 
                    y <= (y1 + padding)
                ) {
                    // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç —Å –∫—Ä–∞—Å–Ω–æ–≥–æ –Ω–∞ —Å–∏–Ω–∏–π –∏–ª–∏ –Ω–∞–æ–±–æ—Ä–æ—Ç
                    item.color = item.color === 'red' ? 'blue' : 'red';
                    
                    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤—Å–µ —á–∏—Å–ª–∞
                    drawNumbersWithColor(ctx);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º input –∏ —Å—É–º–º—É, –ø–æ–∫–∞–∑—ã–≤–∞—è —Ç–æ–ª—å–∫–æ —Å–∏–Ω–∏–µ —á–∏—Å–ª–∞
                    updateInputAndSum();
                    break;
                }
            }
        }

        // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–≤–æ–¥–∞ –∏ —Å—É–º–º—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–∏–Ω–∏—Ö —á–∏—Å–µ–ª
        function updateInputAndSum() {
            const numbersDiv = document.getElementById('numbers');
            const resultDiv = document.getElementById('result');
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–∞ —Å —Å–∏–Ω–∏–º —Ü–≤–µ—Ç–æ–º
            const blueNumbers = foundNumbersWithColors.filter(item => item.color === 'blue');
            numbersDiv.style.display = blueNumbers.some(item => item.value) ? 'block' : 'none';
            
            if (blueNumbers.length > 0) {
                // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Å —á–∏—Å–ª–∞–º–∏ –¥–ª—è –≤–≤–æ–¥–∞
                const formattedNumbers = blueNumbers.map((num, i) => i > 0 ? `+${num.value}` : `${num.value}`).join('');
                
                numbersDiv.textContent = formattedNumbers;
                
                // –í—ã—á–∏—Å–ª—è–µ–º —Å—É–º–º—É —Ç–æ–ª—å–∫–æ —Å–∏–Ω–∏—Ö —á–∏—Å–µ–ª
                const blueSum = blueNumbers.reduce((sum, num) => sum + num.value, 0);
                resultDiv.textContent = `–°—É–º–º–∞: ${Number(blueSum.toFixed(2))}`;
            } else {
                numbersDiv.textContent = '';
                resultDiv.textContent = '–°—É–º–º–∞: 0';
            }
        }

        function extractAndSumNumbers(text, words, foundNumbers) {
            let currentNumber = '';
            let currentBBox = null;
            
            // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –±–ª–∏–∑–∫–∏—Ö —Å–ª–æ–≤
            const mergedWords = [];
            for (let i = 0; i < words.length; i++) {
                const word = words[i];
                const nextWord = words[i + 1];
                
                if (nextWord && Math.abs(word.bbox.x1 - nextWord.bbox.x0) < 30) {
                    word.text += nextWord.text;
                    word.bbox.x1 = nextWord.bbox.x1;
                    i++; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–ª–µ–¥—É—é—â–µ–µ —Å–ª–æ–≤–æ, —Ç–∞–∫ –∫–∞–∫ –º—ã –µ–≥–æ —É–∂–µ –æ–±—ä–µ–¥–∏–Ω–∏–ª–∏
                }
                mergedWords.push(word);
            }
            
            mergedWords.forEach((word, index) => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–≤—É—Ö –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –±—É–∫–≤ (–∫–∏—Ä–∏–ª–ª–∏—Ü–∞ –∏ –ª–∞—Ç–∏–Ω–∏—Ü–∞)
                if (/[–∞-—è–ê-–Øa-zA-Z]{2}/.test(word.text)) {
                    return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–ª–æ–≤–∞ —Å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º–∏ –±—É–∫–≤–∞–º–∏
                }
                
                // –£–ª—É—á—à–µ–Ω–Ω–æ–µ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ —á–∏—Å–µ–ª
                const matches = word.text.match(/[+-]?\d+[,\s]?\d*\.?\d*/g);
                
                if (matches) {
                    matches.forEach(match => {
                        const cleanNumber = match
                            .replace(/\s/g, '')
                            .replace(/,/g, '.')
                            .replace(/\.(?=.*\.)/g, ''); // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω—é—é —Ç–æ—á–∫—É
                        
                        const num = parseFloat(cleanNumber);
                        if (!isNaN(num)) {
                            foundNumbers.push({
                                value: num,
                                bbox: word.bbox,
                                color: 'red' // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –≤—Å–µ —á–∏—Å–ª–∞ –∫—Ä–∞—Å–Ω—ã–µ
                            });
                        }
                    });
                }
            });
            
            const totalSum = foundNumbers.reduce((sum, num) => sum + num.value, 0);
            return Number(totalSum.toFixed(2));
        }

        async function init() {
            await initTesseract();

            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');
            const numbersDiv = document.getElementById('numbers');
            const resultDiv = document.getElementById('result');

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ–±–ª–∞—Å—Ç–∏ –∑–∞–≥—Ä—É–∑–∫–∏
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è drag&drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.backgroundColor = 'rgba(0, 122, 255, 0.2)';
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.backgroundColor = 'rgba(0, 122, 255, 0.05)';
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.backgroundColor = 'rgba(0, 122, 255, 0.05)';
                
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    processImage(e.dataTransfer.files[0]);
                }
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞, —á—Ç–æ–±—ã –æ–Ω —Ä–∞–±–æ—Ç–∞–ª —Ç–æ–ª—å–∫–æ —Å —Å–∏–Ω–∏–º–∏ —á–∏—Å–ª–∞–º–∏
            numbersDiv.addEventListener('input', () => {
                const text = numbersDiv.textContent;
                const numbers = text.replace('–ß–∏—Å–ª–∞: ', '')
                    .replace(/\s+/g, '') // –£–¥–∞–ª—è–µ–º –≤—Å–µ –ø—Ä–æ–±–µ–ª—ã
                    .split(/([+-])/) // –†–∞–∑–¥–µ–ª—è–µ–º –ø–æ –∑–Ω–∞–∫–∞–º + –∏ -
                    .filter(n => n) // –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
                    .reduce((acc, curr, i, arr) => {
                        // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π —ç–ª–µ–º–µ–Ω—Ç —ç—Ç–æ –∑–Ω–∞–∫
                        if (curr === '+' || curr === '-') {
                            // –î–æ–±–∞–≤–ª—è–µ–º –∑–Ω–∞–∫ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —á–∏—Å–ª—É
                            arr[i + 1] = curr + arr[i + 1];
                            return acc;
                        }
                        // –ï—Å–ª–∏ —ç—Ç–æ —á–∏—Å–ª–æ, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –≤ –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä
                        if (!isNaN(parseFloat(curr))) {
                            acc.push(parseFloat(curr));
                        }
                        return acc;
                    }, []);
                
                const sum = numbers.reduce((acc, curr) => acc + curr, 0);
                resultDiv.textContent = `–°—É–º–º–∞: ${Number(sum.toFixed(2))}`;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç–∞ —á–∏—Å–µ–ª, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑–º–µ–Ω–∏–ª –≤–≤–æ–¥ –≤—Ä—É—á–Ω—É—é
                // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) {
                    processImage(e.target.files[0]);
                }
            });
        }

        init();
    </script>
</body>
</html>
<style>
    .sticky-header {
        position: sticky;
        top: 0;
        background: var(--card-bg);
        padding: 16px;
        border-radius: 0 0 var(--radius) var(--radius);
        box-shadow: var(--shadow);
        z-index: 100;
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
        margin: -24px -24px 24px -24px;
        width: calc(100% + 48px);
    }

    .operation-button {
        padding: 16px;
        border-radius: var(--radius);
        border: 1px solid var(--border-color);
        background: var(--card-bg);
        color: var(--text-primary);
        font-size: 24px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
    }

    .operation-button:hover {
        background: var(--primary-color);
        color: white;
        transform: translateY(-2px);
    }

    .operation-button.active {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
        color: white;
        border: none;
    }
</style>
