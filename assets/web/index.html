<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —á–∏—Å–µ–ª —Å —Ñ–æ—Ç–æ</title>
    <link rel="manifest" href="manifest.json">
    <script src='https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js'></script>
    <style>
        :root {
            /* –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ */
            --primary-color-light: #6366F1;
            --primary-hover-light: #4F46E5;
            --background-light: #F9FAFB;
            --card-bg-light: #FFFFFF;
            --text-primary-light: #1F2937;
            --text-secondary-light: #6B7280;
            --border-color-light: #E5E7EB;
            
            /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –≤ —Å—Ç–∏–ª–µ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ Apple */
            --primary-color-dark: #FF9F0A;
            --primary-hover-dark: #FFB340;
            --background-dark: #000000;
            --card-bg-dark: #1C1C1E;
            --text-primary-dark: #000000;
            --text-secondary-dark: #98989F;
            --border-color-dark: #2C2C2E;
            
            /* –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Ç–µ–º–Ω–∞—è —Ç–µ–º–∞) */
            --primary-color: var(--primary-color-dark);
            --primary-hover: var(--primary-hover-dark);
            --background: var(--background-dark);
            --card-bg: var(--card-bg-dark);
            --text-primary: var(--text-primary-dark);
            --text-secondary: var(--text-secondary-dark);
            --border-color: var(--border-color-dark);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 16px;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --primary-color: var(--primary-color-dark);
                --primary-hover: var(--primary-hover-dark);
                --background: var(--background-dark);
                --card-bg: var(--card-bg-dark);
                --text-primary: var(--text-primary-dark);
                --text-secondary: var(--text-secondary-dark);
                --border-color: var(--border-color-dark);
                --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", system-ui, sans-serif;
            min-height: 100vh;
            background-color: var(--background);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
        }

        .container {
            flex: 1;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
            min-height: calc(100vh - 48px);
            width: 100%;
            position: relative;
            z-index: 1;
        }

        .sticky-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(
                to bottom,
                rgba(217, 217, 234, 0.2) 0%,
                rgba(217, 217, 234, 0.2) 60%,
                rgba(217, 217, 234, 0) 100%
            );
            padding: 16px;
            z-index: 100;
            display: none;  /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç */
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
            margin: 0;
            width: 100%;
            -webkit-mask-image: linear-gradient(
                to bottom,
                black 0%,
                black 60%,
                transparent 100%
            );
            mask-image: linear-gradient(
                to bottom,
                black 0%,
                black 60%,
                transparent 100%
            );
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            /* background: rgba(217, 217, 234, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px); */
            padding: 16px;
            z-index: 100;
            display: flex;
            margin: 0;
            width: 100%;
            border-radius: 12px 12px 0 0;
        }

        .operation-button {
            padding: 24px;
            border-radius: 50%;
            border: none;
            background: var(--primary-color);
            color: white;
            font-size: 32px;
            font-weight: normal;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1;
            width: 64px;
            height: 64px;
            margin: 0 auto;
            border: none;
            -webkit-tap-highlight-color: transparent;
        }

        .operation-button:active {
            transform: scale(0.9);
            background: white;
            color: var(--primary-color);
        }

        .canvas-container {
            position: relative;
            height: 100vh;
            width: 100vw;
            display: none; /* –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç */
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        #canvas {
            width: 100vw;
            border-radius: var(--radius);
            display: none;
            box-shadow: var(--shadow);
            background: var(--card-bg);
            transform-origin: center;
            cursor: move;
            touch-action: none;
            z-index: 1;
        }

        #numbers, #result {
            transition: all 0.3s ease;
            z-index: 10;
        }

        #numbers {
            top: 12px;
            font-size: 1.25rem;
            line-height: 1.5;
            color: var(--text-primary);
        }

        #numbers:focus {
            outline: none;
        }

        #result {
            font-size: 2.5rem;
            font-weight: 500;
            margin-bottom: 42px;
            color: var(--text-primary);
        }

        #fileInput {
            display: none;
        }

        .loading {
            display: none;
            text-align: center;
            color: var(--text-secondary);
            font-size: 1.1rem;
            padding: 16px;
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            animation: pulse 2s infinite;
        }

        .upload-area {
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background: var(--card-bg);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-height: inherit;
        }

        .upload-area.hidden {
            display: none;
        }

        .upload-area:hover {
            background: rgba(99, 102, 241, 0.05);
            transform: translateY(-2px);
        }

        .upload-area p {
            color: var(--primary-color);
            font-size: 1.25rem;
            font-weight: 500;
            margin-top: 16px;
        }

        .upload-icon {
            font-size: 48px;
            color: var(--primary-color);
            margin-bottom: 16px;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <video id="backgroundCamera" autoplay playsinline style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1;"></video>
    
    <div class="container">
        <input type="file" id="fileInput" accept="image/*">
        <div id="loading" class="loading">
            –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...
        </div>
        <div class="canvas-container">
            <canvas id="canvas"></canvas>
        </div>
        <div class="sticky-header">
            <div id="numbers" contenteditable="true"></div>
            <div id="result"></div>
        </div>
        <div class="upload-area" id="uploadArea" style="background: transparent;">
            <div class="upload-icon">üì∏</div>
            <p>–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –≥–∞–ª–µ—Ä–µ–∏</p>
        </div>
        <div class="footer">
            <button class="operation-button active" data-operation="+" onclick="setOperation('+')">+</button>
            <button class="operation-button" data-operation="-" onclick="setOperation('-')">‚àí</button>
            <button class="operation-button" data-operation="*" onclick="setOperation('√ó')">√ó</button>
            <button class="operation-button" data-operation="/" onclick="setOperation('√∑')">√∑</button>
        </div>
    </div>
    
    <script>
        const INACTIVE_NUMBER_COLOR = '#616161'
        const ACTIVE_NUMBER_COLOR = '#3b3b3b'
        let worker;
        let foundNumbersWithColors = [];
        let scale = 1;
        let initialPinchDistance = null;
        let isDragging = false;
        let startX, startY, translateX = 0, translateY = 0;
        let currentOperation = '+'; // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è —Ç–µ–∫—É—â–µ–π –æ–ø–µ—Ä–∞—Ü–∏–∏

        async function initTesseract() {
            worker = await Tesseract.createWorker({
                logger: m => {
                    const loading = document.getElementById('loading');
                    loading.style.display = 'none';
                    loading.textContent = m.status;
                }
            });
            await worker.loadLanguage('eng');
            await worker.initialize('eng');
        }

        async function processImage(file) {
            const canvas = document.getElementById('canvas');
            const canvasContainer = document.querySelector('.canvas-container');

            let scale = 1;
            let translateX = 0;
            let translateY = 0;
            let startX, startY;
            let startDistance;
            let isDragging = false;
            let isZooming = false;

            const lerp = (start, end, t) => start + (end - start) * t;

            const handleTouchStart = (event) => {
                if (event.touches.length === 1) {
                    isDragging = true;
                    startX = event.touches[0].clientX - translateX;
                    startY = event.touches[0].clientY - translateY;
                } else if (event.touches.length === 2) {
                    isZooming = true;
                    startDistance = Math.sqrt(
                        Math.pow(event.touches[0].clientX - event.touches[1].clientX, 2) +
                        Math.pow(event.touches[0].clientY - event.touches[1].clientY, 2)
                    );
                }
            };

            const handleTouchMove = (event) => {
                event.preventDefault(); // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–∏

                if (isZooming && event.touches.length === 2) {
                    const currentDistance = Math.sqrt(
                        Math.pow(event.touches[0].clientX - event.touches[1].clientX, 2) +
                        Math.pow(event.touches[0].clientY - event.touches[1].clientY, 2)
                    );
                    const diff = currentDistance - startDistance;

                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—é –¥–ª—è –±–æ–ª–µ–µ –ø–ª–∞–≤–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–∞—Å—à—Ç–∞–±–∞
                    const targetScale = Math.min(Math.max(0.125, scale + diff * 0.005), 4); // –ò–∑–º–µ–Ω—è–µ–º 0.005 –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                    scale = lerp(scale, targetScale, 0.2);  // –ü–∞—Ä–∞–º–µ—Ç—Ä 0.2 –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç –ø–ª–∞–≤–Ω–æ—Å—Ç—å

                    const transformValue = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
                    canvas.style.transform = transformValue;
                } else if (isDragging && event.touches.length === 1) {
                    translateX = event.touches[0].clientX - startX;
                    translateY = event.touches[0].clientY - startY;
                    canvas.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
                }
            };

            const handleTouchEnd = () => {
                isDragging = false;
                isZooming = false;
                startDistance = null;
            };

            canvasContainer.addEventListener('touchstart', handleTouchStart);
            canvasContainer.addEventListener('touchmove', handleTouchMove);
            canvasContainer.addEventListener('touchend', handleTouchEnd);

            const ctx = canvas.getContext('2d');
            const resultDiv = document.getElementById('result');
            const numbersDiv = document.getElementById('numbers');
            const loading = document.getElementById('loading');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫–∏ —Å —á–∏—Å–ª–∞–º–∏ –∏ —Å—É–º–º–æ–π
            resultDiv.style.display = 'block';
            canvasContainer.style.display = 'flex'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            
            const img = new Image();
            img.src = URL.createObjectURL(file);
            
            await new Promise(resolve => {
                img.onload = resolve;
            });
            
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            ctx.drawImage(img, 0, 0);
            canvas.style.display = 'block';
            loading.style.display = 'block';
            
            try {
                const { data } = await worker.recognize(canvas);
                
                // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —á–∏—Å–ª–∞
                foundNumbersWithColors = [];
                const sum = extractAndSumNumbers(data.text, data.words, foundNumbersWithColors);
                
                // –û–±–≤–æ–¥–∏–º —á–∏—Å–ª–∞ –ø–æ—Å–ª–µ –∏—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º —Å—Ç–∏–ª–µ–º
                drawNumbersWithColor(ctx);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫–∞–Ω–≤–∞—Å
                canvas.addEventListener('click', handleCanvasClick);
            } catch (error) {
                resultDiv.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è';
                console.error('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:', error);
                canvasContainer.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏ –æ—à–∏–±–∫–µ
            } finally {
                loading.style.display = 'none';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –≤—Å–µ—Ö —á–∏—Å–µ–ª —Å –∏—Ö —Ç–µ–∫—É—â–∏–º —Ü–≤–µ—Ç–æ–º
        function drawNumbersWithColor(ctx) {
            // –û—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ç—É—Ä—ã, –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            const canvas = ctx.canvas;
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            foundNumbersWithColors.forEach((item) => {
                const { bbox, color } = item;
                const { x0, y0, x1, y1 } = bbox;
                const padding = 4;
                
                // –ó–∞–ª–∏–≤–∞–µ–º –æ–±–ª–∞—Å—Ç—å —á–∏—Å–ª–∞ —Ü–≤–µ—Ç–æ–º –≤–º–µ—Å—Ç–æ –æ–±–≤–æ–¥–∫–∏
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.roundRect(
                    x0 - padding, 
                    y0 - padding, 
                    x1 - x0 + padding * 2, 
                    y1 - y0 + padding * 2, 
                    8
                );
                ctx.fill();
                
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç —á–∏—Å–ª–∞ –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                const numberWidth = x1 - x0;
                const numberHeight = y1 - y0;
                const imageData = ctx.getImageData(x0, y0, numberWidth, numberHeight);
                
                // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç —á–∏—Å–ª–∞ –ø–æ–≤–µ—Ä—Ö –∑–∞–ª–∏–≤–∫–∏ –±–µ–ª—ã–º —Ü–≤–µ—Ç–æ–º
                ctx.fillStyle = 'white';
                ctx.font = `${numberHeight * 1.2}px -apple-system, BlinkMacSystemFont, "SF Pro Display", system-ui, sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(item.value.toString(), x0 + numberWidth / 2, y0 + numberHeight / 2);
            });
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫–∞–Ω–≤–∞—Å
        function handleCanvasClick(e) {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–∞–Ω–≤–∞—Å–∞
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–ø–∞–ª –ª–∏ –∫–ª–∏–∫ –Ω–∞ –∫–∞–∫–æ–µ-–ª–∏–±–æ —á–∏—Å–ª–æ
            for (let i = 0; i < foundNumbersWithColors.length; i++) {
                const item = foundNumbersWithColors[i];
                const { bbox } = item;
                const { x0, y0, x1, y1 } = bbox;
                const padding = 4;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Ö–æ–¥—è—Ç –ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞ –≤ –æ–±–ª–∞—Å—Ç—å —á–∏—Å–ª–∞
                if (
                    x >= (x0 - padding) && 
                    x <= (x1 + padding) && 
                    y >= (y0 - padding) && 
                    y <= (y1 + padding)
                ) {
                    // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç —Å –∫—Ä–∞—Å–Ω–æ–≥–æ –Ω–∞ —Å–∏–Ω–∏–π –∏–ª–∏ –Ω–∞–æ–±–æ—Ä–æ—Ç
                    item.color = item.color === INACTIVE_NUMBER_COLOR ? ACTIVE_NUMBER_COLOR : INACTIVE_NUMBER_COLOR;
                    
                    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤—Å–µ —á–∏—Å–ª–∞
                    drawNumbersWithColor(ctx);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º input –∏ —Å—É–º–º—É, –ø–æ–∫–∞–∑—ã–≤–∞—è —Ç–æ–ª—å–∫–æ —Å–∏–Ω–∏–µ —á–∏—Å–ª–∞
                    updateInputAndSum(item);
                    break;
                }
            }
        }

        // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–≤–æ–¥–∞ –∏ —Å—É–º–º—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–∏–Ω–∏—Ö —á–∏—Å–µ–ª
        function setOperation(operation) {
            currentOperation = operation;
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.operation-button').forEach(button => {
                button.classList.remove('active');
                if (button.dataset.operation === operation) {
                    button.classList.add('active');
                }
            });
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –Ω–æ–≤–æ–π –æ–ø–µ—Ä–∞—Ü–∏–µ–π
            const numbersDiv = document.getElementById('numbers');
            if (numbersDiv.textContent) {
                updateResult();
            }
        }

        function updateInputAndSum(_item) {
            const numbersDiv = document.getElementById('numbers');
            const resultDiv = document.getElementById('result');
            const stickyHeader = document.querySelector('.sticky-header');
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ —á–∏—Å–ª–∞
            const activeNumbers = _item.color === ACTIVE_NUMBER_COLOR 
                ? [...foundNumbersWithColors.filter(item => item.color === ACTIVE_NUMBER_COLOR && item.value !== _item.value), _item] 
                : foundNumbersWithColors.filter(item => item.color === ACTIVE_NUMBER_COLOR);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º sticky-header –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–ª–∏—á–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∏—Å–µ–ª
            stickyHeader.style.display = activeNumbers.length > 0 ? 'flex' : 'none';
            
            numbersDiv.style.display = activeNumbers.some(item => item.value) ? 'block' : 'none';
            
            if (activeNumbers.length > 0) {
                // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Å —á–∏—Å–ª–∞–º–∏ –∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏
                const formattedNumbers = activeNumbers.map((num, i) => {
                    if (i === 0) return num.value;
                    return `${currentOperation}${num.value}`;
                }).join('');
                
                numbersDiv.textContent = formattedNumbers;
                
                // –í—ã—á–∏—Å–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                updateResult();
            } else {
                numbersDiv.textContent = '';
                resultDiv.textContent = '= 0';
            }
        }

        function updateResult() {
            const numbersDiv = document.getElementById('numbers');
            const resultDiv = document.getElementById('result');
            const numbers = foundNumbersWithColors
                .filter(item => item.color === ACTIVE_NUMBER_COLOR)
                .map(item => item.value);
            
            let result = numbers[0] || 0;
            
            for (let i = 1; i < numbers.length; i++) {
                switch (currentOperation) {
                    case '+':
                        result += numbers[i];
                        break;
                    case '-':
                        result -= numbers[i];
                        break;
                    case '*':
                        result *= numbers[i];
                        break;
                    case '/':
                        result /= numbers[i];
                        break;
                }
            }
            
            resultDiv.textContent = `= ${Number(result.toFixed(2))}`;
        }

        function extractAndSumNumbers(text, words, foundNumbers) {
            let currentNumber = '';
            let currentBBox = null;
            
            // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –±–ª–∏–∑–∫–∏—Ö —Å–ª–æ–≤
            const mergedWords = [];
            for (let i = 0; i < words.length; i++) {
                const word = words[i];
                const nextWord = words[i + 1];
                
                if (nextWord && Math.abs(word.bbox.x1 - nextWord.bbox.x0) < 30) {
                    word.text += nextWord.text;
                    word.bbox.x1 = nextWord.bbox.x1;
                    i++; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–ª–µ–¥—É—é—â–µ–µ —Å–ª–æ–≤–æ, —Ç–∞–∫ –∫–∞–∫ –º—ã –µ–≥–æ —É–∂–µ –æ–±—ä–µ–¥–∏–Ω–∏–ª–∏
                }
                mergedWords.push(word);
            }
            
            mergedWords.forEach((word, index) => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–≤—É—Ö –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –±—É–∫–≤ (–∫–∏—Ä–∏–ª–ª–∏—Ü–∞ –∏ –ª–∞—Ç–∏–Ω–∏—Ü–∞)
                if (/[–∞-—è–ê-–Øa-zA-Z]{2}/.test(word.text)) {
                    return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–ª–æ–≤–∞ —Å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º–∏ –±—É–∫–≤–∞–º–∏
                }
                
                // –£–ª—É—á—à–µ–Ω–Ω–æ–µ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ —á–∏—Å–µ–ª
                const matches = word.text.match(/[+-]?\d+[,\s]?\d*\.?\d*/g);
                
                if (matches) {
                    matches.forEach(match => {
                        const cleanNumber = match
                            .replace(/\s/g, '')
                            .replace(/,/g, '.')
                            .replace(/\.(?=.*\.)/g, ''); // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω—é—é —Ç–æ—á–∫—É
                        
                        const num = parseFloat(cleanNumber);
                        if (!isNaN(num)) {
                            foundNumbers.push({
                                value: num,
                                bbox: word.bbox,
                                color: INACTIVE_NUMBER_COLOR // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –≤—Å–µ —á–∏—Å–ª–∞ –∫—Ä–∞—Å–Ω—ã–µ
                            });
                        }
                    });
                }
            });
            
            const totalSum = foundNumbers.reduce((sum, num) => sum + num.value, 0);
            return Number(totalSum.toFixed(2));
        }

        async function init() {
            await initTesseract();

            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');
            const numbersDiv = document.getElementById('numbers');
            const resultDiv = document.getElementById('result');

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ–±–ª–∞—Å—Ç–∏ –∑–∞–≥—Ä—É–∑–∫–∏
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è drag&drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.backgroundColor = 'rgba(0, 122, 255, 0.2)';
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.backgroundColor = 'rgba(0, 122, 255, 0.05)';
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.backgroundColor = 'rgba(0, 122, 255, 0.05)';
                
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    processImage(e.dataTransfer.files[0]);
                }
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞, —á—Ç–æ–±—ã –æ–Ω —Ä–∞–±–æ—Ç–∞–ª —Ç–æ–ª—å–∫–æ —Å —Å–∏–Ω–∏–º–∏ —á–∏—Å–ª–∞–º–∏
            numbersDiv.addEventListener('input', () => {
                const text = numbersDiv.textContent;
                const numbers = text.replace('–ß–∏—Å–ª–∞: ', '')
                    .replace(/\s+/g, '') // –£–¥–∞–ª—è–µ–º –≤—Å–µ –ø—Ä–æ–±–µ–ª—ã
                    .split(/([+-])/) // –†–∞–∑–¥–µ–ª—è–µ–º –ø–æ –∑–Ω–∞–∫–∞–º + –∏ -
                    .filter(n => n) // –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
                    .reduce((acc, curr, i, arr) => {
                        // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π —ç–ª–µ–º–µ–Ω—Ç —ç—Ç–æ –∑–Ω–∞–∫
                        if (curr === '+' || curr === '-') {
                            // –î–æ–±–∞–≤–ª—è–µ–º –∑–Ω–∞–∫ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —á–∏—Å–ª—É
                            arr[i + 1] = curr + arr[i + 1];
                            return acc;
                        }
                        // –ï—Å–ª–∏ —ç—Ç–æ —á–∏—Å–ª–æ, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –≤ –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä
                        if (!isNaN(parseFloat(curr))) {
                            acc.push(parseFloat(curr));
                        }
                        return acc;
                    }, []);
                
                const sum = numbers.reduce((acc, curr) => acc + curr, 0);
                resultDiv.textContent = `= ${Number(sum.toFixed(2))}`;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç–∞ —á–∏—Å–µ–ª, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑–º–µ–Ω–∏–ª –≤–≤–æ–¥ –≤—Ä—É—á–Ω—É—é
                // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) {
                    processImage(e.target.files[0]);
                }
            });
        }

        init();
    </script>
</body>
</html>