<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Анализатор чисел с фото</title>
    <script src='https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js'></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }
        canvas {
            display: none;
        }
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-family: system-ui, -apple-system, sans-serif;
            z-index: 100;
        }
    </style>
</head>

<body>
    <div id="loading" class="loading" style="display: none;">
        Обработка изображения...
    </div>
    <canvas id="canvas"></canvas>

    <script>
        let worker;

        // Инициализация Tesseract
        async function initTesseract() {
            worker = await Tesseract.createWorker({
                logger: m => {
                    const loading = document.getElementById('loading');
                    loading.textContent = m.status;
                }
            });
            await worker.loadLanguage('eng');
            await worker.initialize('eng');
            
            // Сообщаем в React Native, что Tesseract инициализирован
            sendMessageToReactNative({
                type: 'tesseractInitialized',
                success: true
            });
        }

        // Функция для обработки изображения
        async function processImage(imageData) {
            const loading = document.getElementById('loading');
            loading.style.display = 'flex';
            
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            try {
                // Создаем изображение из полученных данных
                const img = new Image();
                
                const imgLoaded = new Promise((resolve) => {
                    img.onload = resolve;
                });
                
                if (imageData.startsWith('data:image')) {
                    img.src = imageData;
                } else {
                    img.src = 'data:image/jpeg;base64,' + imageData;
                }
                
                await imgLoaded;
                
                // Устанавливаем размеры canvas
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;
                ctx.drawImage(img, 0, 0);
                
                // Распознаем текст
                const { data } = await worker.recognize(canvas);
                
                // Извлекаем числа и их координаты
                const numbers = extractNumbers(data.words);
                
                // Отправляем результаты в React Native
                sendMessageToReactNative({
                    type: 'recognitionComplete',
                    numbers: numbers
                });
            } catch (error) {
                console.error('Ошибка при обработке изображения:');
                sendMessageToReactNative({
                    type: 'error',
                    message: 'Ошибка при обработке изображения: ' + error.message
                });
            } finally {
                loading.style.display = 'none';
            }
        }

        // Функция для извлечения чисел и их координат
        function extractNumbers(words) {
            const foundNumbers = [];
            
            // Предварительная обработка для объединения близких слов
            const mergedWords = [];
            for (let i = 0; i < words.length; i++) {
                const word = words[i];
                const nextWord = words[i + 1];

                if (nextWord && Math.abs(word.bbox.x1 - nextWord.bbox.x0) < 30) {
                    word.text += nextWord.text;
                    word.bbox.x1 = nextWord.bbox.x1;
                    i++; // Пропускаем следующее слово, так как мы его уже объединили
                }
                mergedWords.push(word);
            }

            mergedWords.forEach((word) => {
                // Пропускаем слова с последовательными буквами (кириллица и латиница)
                if (/[а-яА-Яa-zA-Z]{2}/.test(word.text)) {
                    return;
                }

                // Ищем числа с улучшенным регулярным выражением
                const matches = word.text.match(/[+-]?\d+[,\s]?\d*\.?\d*/g);

                if (matches) {
                    matches.forEach(match => {
                        // Очищаем и форматируем число
                        const cleanNumber = match
                            .replace(/\s/g, '')
                            .replace(/,/g, '.')
                            .replace(/\.(?=.*\.)/g, ''); // Оставляем только последнюю точку

                        const num = parseFloat(cleanNumber);
                        if (!isNaN(num)) {
                            foundNumbers.push({
                                value: num,
                                bbox: word.bbox
                            });
                        }
                    });
                }
            });

            return foundNumbers;
        }

        // Функция для отправки сообщений в React Native
        function sendMessageToReactNative(message) {
            if (window.ReactNativeWebView) {
                window.ReactNativeWebView.postMessage(JSON.stringify(message));
            } else {
                console.log('ReactNativeWebView not available');
            }
        }

        // Слушатель для сообщений из React Native
        window.addEventListener('message', function(event) {
            try {
                const message = JSON.parse(event.data);
                
                if (message.type === 'processImage') {
                    processImage(message.imageData);
                }
            } catch (e) {
                console.error('Ошибка при обработке сообщения из React Native:');
            }
        });

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', initTesseract);
    </script>
</body>

</html>